const line=(e,t,a)=>{const s=24,c=24,i=24,n=48;let o=0,r=0;const l=d3.select(`.line-${t}`),d=l.select("svg"),p={};let h;const v=d3.timeParse("%Y-%m-%d");let u;const m=()=>{const e=d3.scaleTime().domain(d3.extent(h,e=>e.dia)),t=d3.scaleLinear().domain([0,d3.max(h,e=>1.25*e.visitas)]);p.count={x:e,y:t}},f=e=>{l.select(".tooltip").remove(),u=l.append("div").attr("class","tooltip tooltip-cachitos");(e=>{h[0].diferencia>0?u.data(h).html(e=>`\n                        <p class="tooltip-text">Las visitas aumentaron en un: <span class="tooltip-number">${e.diferencia}%</span></p>\n\n                        `).transition().duration(300):u.attr("class","tooltip tooltip-negative").data(h).html(e=>`\n                        <p class="tooltip-text">Las visitas descendieron en un: <span class="tooltip-number">${e.diferencia}%</span></p>\n\n                        `).transition().duration(300)})()},x=e=>{const h=l.node().offsetWidth;o=h-n-c,r=600-s-i,d.attr("width",h).attr("height",600);const v=`translate(${n},${s})`,u=d.select(`.line-${t}-container`);u.attr("transform",v);const m=d3.line().x(e=>p.count.x(e.dia)).y(e=>p.count.y(e.visitas));((e,t)=>{p.count.x.range([0,e]),p.count.y.range([t,0])})(o,r);const f=l.select(`.line-${t}-container-dos`),x=f.selectAll(".line").data([e]),S=x.enter().append("path").attr("class","line").attr("stroke-width","1.5"),g=f.selectAll(".circles").data(e),y=g.enter().append("circle").attr("class","circles");x.merge(S).transition().duration(600).ease(d3.easeLinear).attr("d",m),g.merge(y).transition().duration(600).ease(d3.easeLinear).attr("cx",e=>p.count.x(e.dia)).attr("cy",e=>p.count.y(e.visitas)).attr("r",e=>e.fecha===a?5:0),(e=>{const t=d3.axisBottom(p.count.x).tickFormat(d3.timeFormat("%m-%d")).ticks(13);e.select(".axis-x").attr("transform",`translate(0,${r})`).call(t);const a=d3.axisLeft(p.count.y).tickFormat(d3.format("d")).ticks(5).tickSizeInner(-o);e.select(".axis-y").call(a)})(u)};const S=()=>{d3.csv(e,a=>{const s=Array.from(d3.group(a,e=>e.artista),([e,t])=>({key:e,value:t})),c=d3.select(`#select-${t}`);c.selectAll("option").data(s).enter().append("option").attr("value",e=>e.key).text(e=>e.key),c.on("change",function(){d3.select(this).property("value");d3.csv(e,e=>{h=e;let a=d3.select(`#select-${t}`).property("value");(h=h.filter(e=>String(e.artista).match(a))).forEach(e=>{e.nombre=e.artista,e.visitas=+e.visitas,e.dia=v(e.fecha),m()}),f(h),x(h)})})})};window.addEventListener("resize",()=>{x(h)}),d3.csv(e,e=>{const a=e[0].artista;(h=e.filter(e=>String(e.artista).match(a))).forEach(e=>{e.nombre=e.artista,e.visitas=+e.visitas,e.dia=v(e.fecha)}),console.log(h),S(),(()=>{const e=d.select(`.line-${t}-container`);e.append("g").attr("class","axis axis-x"),e.append("g").attr("class","axis axis-y"),e.append("g").attr("class",`line-${t}-container-dos`)})(),m(),f(h),x(h)})};let prueba=["csv/episodio-uno.csv","chapter-one","2019-05-28"];line(prueba[0],prueba[1],prueba[2]);const cachitos=[["csv/episodio-uno.csv","chapter-one","2019-04-23"],["csv/episodio-dos.csv","chapter-two","2019-05-21"],["csv/episodio-tres.csv","chapter-three","2019-05-28"],["csv/episodio-cuatro.csv","chapter-four","2019-06-04"],["csv/episodio-cinco.csv","chapter-five","2019-06-11"],["csv/episodio-seis.csv","chapter-six","2019-06-18"],["csv/episodio-siete.csv","chapter-seven","2019-06-25"]];for(const e of cachitos)line(...e);new SlimSelect({select:"#select-chapter-one",searchPlaceholder:"Selecciona una artista..."}),new SlimSelect({select:"#select-chapter-two",searchPlaceholder:"Selecciona una artista..."}),new SlimSelect({select:"#select-chapter-three",searchPlaceholder:"Selecciona una artista..."}),new SlimSelect({select:"#select-chapter-four",searchPlaceholder:"Selecciona una artista..."}),new SlimSelect({select:"#select-chapter-five",searchPlaceholder:"Selecciona una artista..."}),new SlimSelect({select:"#select-chapter-six",searchPlaceholder:"Selecciona una artista..."}),new SlimSelect({select:"#select-chapter-seven",searchPlaceholder:"Selecciona una artista..."});